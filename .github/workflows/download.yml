name: Download and Upload to Release

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'URL do arquivo para download'
        required: true
        type: string
      release_tag:
        description: 'Tag da release (ex: v1.0.0)'
        required: true
        type: string
      asset_name:
        description: 'Nome do arquivo na release'
        required: false
        type: string
        default: ''
      aria2_options:
        description: 'Opções adicionais do aria2c'
        required: false
        type: string
        default: '-x 16 -s 16 -k 1M'

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup aria2
      run: |
        sudo apt-get update
        sudo apt-get install -y aria2

    - name: Download file with aria2
      run: |
        # Extrair nome do arquivo da URL se não for especificado
        if [ -z "${{ inputs.asset_name }}" ]; then
          FILENAME=$(basename "${{ inputs.download_url }}")
        else
          FILENAME="${{ inputs.asset_name }}"
        fi
        
        echo "Baixando arquivo: $FILENAME"
        aria2c ${{ inputs.aria2_options }} -o "$FILENAME" "${{ inputs.download_url }}"
        
        # Verificar se o download foi bem-sucedido
        if [ ! -f "$FILENAME" ]; then
          echo "Erro: Arquivo não foi baixado"
          exit 1
        fi
        
        echo "Tamanho do arquivo:"
        ls -lh "$FILENAME"
        
        # Salvar nome do arquivo para uso posterior
        echo "FILENAME=$FILENAME" >> $GITHUB_ENV

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.release_tag }}
        name: Release ${{ inputs.release_tag }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          ${{ env.FILENAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify Release
      run: |
        echo "Arquivo ${{ env.FILENAME }} enviado para release ${{ inputs.release_tag }}"
        echo "URL do download: ${{ inputs.download_url }}"
