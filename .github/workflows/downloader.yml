name: Universal Download to Release

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'URL para download (Google Drive ou qualquer outra)'
        required: true
        type: string
      output_filename:
        description: 'Nome personalizado (opcional)'
        required: false
        type: string
        default: ''

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip wget curl jq
        pip3 install gdown

    - name: Detect URL type
      id: detect_url
      run: |
        URL="${{ inputs.download_url }}"
        
        if echo "$URL" | grep -qi "drive.google.com"; then
          echo "is_gdrive=true" >> $GITHUB_OUTPUT
          echo "ğŸ”µ Detectado: Google Drive"
          
          # Extrair ID do arquivo
          FILE_ID=$(echo "$URL" | sed -n \
            -e 's|.*/d/\([a-zA-Z0-9_-]*\).*|\1|p' \
            -e 's|.*id=\([a-zA-Z0-9_-]*\).*|\1|p' \
            -e 's|.*/file/d/\([a-zA-Z0-9_-]*\).*|\1|p')
          
          echo "file_id=$FILE_ID" >> $GITHUB_OUTPUT
          echo "ID do arquivo: $FILE_ID"
        else
          echo "is_gdrive=false" >> $GITHUB_OUTPUT
          echo "ğŸ”µ Detectado: URL normal"
        fi

    - name: Download file
      id: download_file
      run: |
        # FunÃ§Ã£o para baixar do Google Drive
        download_gdrive() {
          local file_id="$1"
          local output="$2"
          
          echo "ğŸ“¥ Baixando do Google Drive com gdown..."
          
          # Tentar com gdown primeiro
          if [ -n "$output" ] && [ "$output" != "" ]; then
            gdown "https://drive.google.com/uc?id=$file_id" -O "$output" || return 1
          else
            gdown "https://drive.google.com/uc?id=$file_id" || return 1
            # Pegar o nome do arquivo baixado
            output=$(ls -1t | grep -v '\.py$\|\.txt$' | head -1)
          fi
          
          echo "$output"
        }
        
        # FunÃ§Ã£o para baixar URL normal
        download_normal() {
          local url="$1"
          local output="$2"
          
          echo "ğŸ“¥ Baixando com wget..."
          
          if [ -n "$output" ] && [ "$output" != "" ]; then
            wget --trust-server-names --content-disposition -O "$output" "$url" || return 1
          else
            # Primeiro, tentar obter o nome do cabeÃ§alho
            filename=$(curl -sI "$url" | grep -i "content-disposition" | grep -o 'filename="[^"]*"' | cut -d'"' -f2)
            
            if [ -z "$filename" ]; then
              # Extrair da URL
              filename=$(basename "$url" | cut -d'?' -f1)
              if [ -z "$filename" ] || [ "$filename" = "/" ]; then
                filename="downloaded_file_$(date +%s)"
              fi
            fi
            
            wget --trust-server-names --content-disposition -O "$filename" "$url" || return 1
            output="$filename"
          fi
          
          echo "$output"
        }
        
        # Executar download baseado no tipo
        if [ "${{ steps.detect_url.outputs.is_gdrive }}" = "true" ]; then
          FILENAME=$(download_gdrive "${{ steps.detect_url.outputs.file_id }}" "${{ inputs.output_filename }}")
        else
          FILENAME=$(download_normal "${{ inputs.download_url }}" "${{ inputs.output_filename }}")
        fi
        
        # Verificar se o download foi bem-sucedido
        if [ ! -f "$FILENAME" ]; then
          echo "âŒ Download falhou! Tentando mÃ©todo alternativo..."
          
          # MÃ©todo alternativo com curl
          if [ -z "${{ inputs.output_filename }}" ] || [ "${{ inputs.output_filename }}" = "" ]; then
            FILENAME="downloaded_file_$(date +%s)"
          else
            FILENAME="${{ inputs.output_filename }}"
          fi
          
          curl -L -o "$FILENAME" "${{ inputs.download_url }}"
        fi
        
        if [ ! -f "$FILENAME" ]; then
          echo "âŒâŒâŒ ERRO CRÃTICO: Download falhou completamente!"
          exit 1
        fi
        
        # InformaÃ§Ãµes do arquivo
        FILESIZE=$(stat -c%s "$FILENAME")
        FILEHASH=$(sha256sum "$FILENAME" | cut -d' ' -f1)
        
        echo "âœ… Download concluÃ­do!"
        echo "ğŸ“„ Nome: $FILENAME"
        echo "ğŸ“ Tamanho: $FILESIZE bytes"
        echo "ğŸ” SHA256: $FILEHASH"
        
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        echo "filesize=$FILESIZE" >> $GITHUB_OUTPUT
        echo "filehash=$FILEHASH" >> $GITHUB_OUTPUT

    - name: Generate release tag
      id: generate_tag
      run: |
        # Usar timestamp para tag Ãºnica
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        RELEASE_TAG="download-$TIMESTAMP"
        echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Tag da release: $RELEASE_TAG"

    - name: Create GitHub Release (API Method)
      id: create_release
      run: |
        FILENAME="${{ steps.download_file.outputs.filename }}"
        RELEASE_TAG="${{ steps.generate_tag.outputs.release_tag }}"
        
        echo "ğŸš€ Criando release: $RELEASE_TAG"
        
        # Criar a release via API
        RELEASE_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases" \
          -d "{
            \"tag_name\": \"$RELEASE_TAG\",
            \"name\": \"$FILENAME\",
            \"body\": \"## ğŸ“¥ Download AutomÃ¡tico\\n\\n**Arquivo:** \`$FILENAME\`\\n\\n**URL Original:** ${{ inputs.download_url }}\\n\\n**Tamanho:** ${{ steps.download_file.outputs.filesize }} bytes\\n\\n**SHA256:** \`${{ steps.download_file.outputs.filehash }}\`\\n\\n**Data:** $(date '+%d/%m/%Y %H:%M:%S')\\n\\n---\\n\\nBaixado automaticamente via GitHub Actions.\",
            \"draft\": false,
            \"prerelease\": false
          }")
        
        # Extrair upload URL da resposta
        UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq -r '.upload_url' | sed 's/{.*}//')
        RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
        
        if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
          echo "âŒ Erro ao criar release!"
          echo "Resposta: $RELEASE_RESPONSE"
          exit 1
        fi
        
        echo "âœ… Release criada! ID: $RELEASE_ID"
        echo "ğŸ“¤ URL para upload: $UPLOAD_URL"
        
        echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
        echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT

    - name: Upload file to Release
      run: |
        FILENAME="${{ steps.download_file.outputs.filename }}"
        UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
        
        echo "ğŸ“¤ Enviando arquivo: $FILENAME"
        
        # Detectar MIME type
        MIME_TYPE=$(file --mime-type -b "$FILENAME")
        
        # Fazer upload do arquivo
        UPLOAD_RESPONSE=$(curl -s \
          -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: $MIME_TYPE" \
          --data-binary @"$FILENAME" \
          "$UPLOAD_URL?name=$FILENAME")
        
        UPLOAD_SUCCESS=$(echo "$UPLOAD_RESPONSE" | jq -r '.browser_download_url')
        
        if [ -n "$UPLOAD_SUCCESS" ] && [ "$UPLOAD_SUCCESS" != "null" ]; then
          echo "âœ…âœ…âœ… ARQUIVO ENVIADO COM SUCESSO!"
          echo "ğŸ”— Download URL: $UPLOAD_SUCCESS"
          echo "download_url=$UPLOAD_SUCCESS" >> $GITHUB_ENV
        else
          echo "âŒ Erro no upload do arquivo!"
          echo "Resposta: $UPLOAD_RESPONSE"
          exit 1
        fi

    - name: Final summary
      run: |
        echo "========================================"
        echo "ğŸ‰ DOWNLOAD E RELEASE CONCLUÃDOS!"
        echo "========================================"
        echo "ğŸ“¦ Arquivo: ${{ steps.download_file.outputs.filename }}"
        echo "ğŸ·ï¸  Release: ${{ steps.generate_tag.outputs.release_tag }}"
        echo "ğŸ“ Tamanho: ${{ steps.download_file.outputs.filesize }} bytes"
        echo "ğŸ”— Download: ${{ env.download_url }}"
        echo "ğŸ”— Origem: ${{ inputs.download_url }}"
        echo "========================================"
