name: Download and Release - Preserve Original Filename

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'URL para download'
        required: true
        type: string
      release_name:
        description: 'Nome da release (opcional)'
        required: false
        type: string
        default: 'Downloaded File'
      aria2_options:
        description: 'OpÃ§Ãµes do aria2c (recomendado para Google Drive: --header="Cookie: ...")'
        required: false
        type: string
        default: '-x 16 -s 16 -k 1M --continue=true --max-tries=0'

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install aria2
      run: |
        sudo apt-get update
        sudo apt-get install -y aria2

    - name: Download file with aria2 (let it choose the filename)
      id: download
      run: |
        echo "ğŸ“¥ Iniciando download com aria2c..."
        echo "URL: ${{ inputs.download_url }}"
        
        # Primeiro, vejamos qual nome o aria2c vai usar
        echo "ğŸ” Verificando informaÃ§Ãµes do arquivo..."
        
        # Baixar SEM especificar nome - deixe o aria2c decidir
        aria2c ${{ inputs.aria2_options }} \
          --dry-run \
          --summary-interval=0 \
          "${{ inputs.download_url }}" 2>&1 | grep "Download complete:" || true
        
        echo "ğŸš€ Iniciando download real..."
        
        # AGORA o download real - SEM o parÃ¢metro -o
        aria2c ${{ inputs.aria2_options }} \
          --summary-interval=0 \
          "${{ inputs.download_url }}"
        
        # Procurar o arquivo mais recente baixado
        echo "ğŸ” Procurando arquivo baixado..."
        
        # Listar arquivos na pasta atual
        echo "ğŸ“ ConteÃºdo da pasta:"
        ls -la
        
        # O aria2c geralmente mantÃ©m o nome original
        # Vamos pegar o arquivo mais recente (excluindo diretÃ³rios)
        DOWNLOADED_FILE=$(find . -maxdepth 1 -type f -printf "%T@ %f\n" | sort -nr | head -1 | cut -d' ' -f2-)
        
        if [ -z "$DOWNLOADED_FILE" ]; then
          # Tentar outra abordagem: arquivos modificados recentemente
          DOWNLOADED_FILE=$(ls -1t | head -1)
        fi
        
        if [ -z "$DOWNLOADED_FILE" ]; then
          echo "âŒ ERRO: NÃ£o consegui encontrar o arquivo baixado!"
          echo "ğŸ“ Lista de arquivos:"
          ls -la
          exit 1
        fi
        
        echo "âœ… Arquivo encontrado: $DOWNLOADED_FILE"
        echo "ğŸ“Š Tamanho: $(ls -lh "$DOWNLOADED_FILE" | awk '{print $5}')"
        echo "ğŸ“ Tipo: $(file -b "$DOWNLOADED_FILE")"
        
        # Salvar o nome EXATO do arquivo
        echo "original_filename=$DOWNLOADED_FILE" >> $GITHUB_OUTPUT
        echo "file_size=$(stat -c%s "$DOWNLOADED_FILE")" >> $GITHUB_OUTPUT

    - name: Generate release tag from filename
      id: generate_tag
      run: |
        # Usar o nome do arquivo (sem extensÃ£o) para a tag
        FILENAME="${{ steps.download.outputs.original_filename }}"
        
        # Remover extensÃ£o para criar tag
        BASENAME=$(basename "$FILENAME")
        NAME_WITHOUT_EXT="${BASENAME%.*}"
        
        if [ "$NAME_WITHOUT_EXT" = "$BASENAME" ]; then
          # Se nÃ£o tem extensÃ£o
          NAME_WITHOUT_EXT="$BASENAME"
        fi
        
        # Criar tag segura (sem caracteres especiais)
        SAFE_TAG=$(echo "$NAME_WITHOUT_EXT" | tr ' ' '_' | tr '.' '_' | tr -cd '[:alnum:]_-' | head -c 50)
        
        # Adicionar timestamp para evitar duplicatas
        TIMESTAMP=$(date +%Y%m%d)
        RELEASE_TAG="${SAFE_TAG}-${TIMESTAMP}"
        
        echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Tag da release: $RELEASE_TAG"

    - name: Create Release with original file
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.generate_tag.outputs.release_tag }}
        name: "${{ inputs.release_name != '' && inputs.release_name || steps.download.outputs.original_filename }}"
        body: |
          ## ğŸ“¥ Download AutomÃ¡tico
          
          **Arquivo Original:** ${{ steps.download.outputs.original_filename }}
          
          **URL:** ${{ inputs.download_url }}
          
          **Tamanho:** ${{ steps.download.outputs.file_size }} bytes
          
          **Data:** $(date +'%d/%m/%Y %H:%M:%S')
          
          ---
          
          Baixado automaticamente via aria2c.
          
          Nome preservado exatamente como fornecido pelo servidor.
        draft: false
        prerelease: false
        generate_release_notes: false
        files: ${{ steps.download.outputs.original_filename }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show summary
      run: |
        echo "âœ… DOWNLOAD CONCLUÃDO!"
        echo "========================"
        echo "ğŸ“„ Arquivo: ${{ steps.download.outputs.original_filename }}"
        echo "ğŸ·ï¸  Release: ${{ steps.generate_tag.outputs.release_tag }}"
        echo "ğŸ“¦ Tamanho: ${{ steps.download.outputs.file_size }} bytes"
        echo "ğŸ”— Origem: ${{ inputs.download_url }}"
        echo "========================"
