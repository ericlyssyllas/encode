name: Download to Release (Fixed)

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'URL para download'
        required: true
        type: string

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl
        # N√£o instalar gdown por padr√£o

    - name: Download file with original name
      id: download_file
      run: |
        URL="${{ inputs.download_url }}"
        
        echo "üîó URL: $URL"
        
        # Primeiro, tentar obter informa√ß√µes do arquivo
        echo "üì° Obtendo informa√ß√µes..."
        
        # Tentar pegar o nome do cabe√ßalho
        HEADERS=$(curl -sI "$URL" || curl -sI -L "$URL" || true)
        FILENAME=$(echo "$HEADERS" | grep -i "content-disposition" | grep -o 'filename="[^"]*"' | cut -d'"' -f2)
        
        # Se n√£o conseguir, tentar extrair da URL
        if [ -z "$FILENAME" ]; then
          FILENAME=$(basename "$URL" | cut -d'?' -f1)
          # Validar nome
          if [ -z "$FILENAME" ] || [ "$FILENAME" = "/" ] || [ "$FILENAME" = "download" ]; then
            FILENAME="file_$(date +%s)"
          fi
        fi
        
        echo "üìÑ Nome do arquivo: $FILENAME"
        
        # Baixar o arquivo
        echo "üì• Baixando..."
        
        # Usar wget que √© mais confi√°vel
        if wget --trust-server-names --content-disposition -O "$FILENAME" "$URL"; then
          echo "‚úÖ Download com wget bem-sucedido"
        else
          echo "‚ö†Ô∏è Wget falhou, tentando curl..."
          curl -L -o "$FILENAME" "$URL"
        fi
        
        # Verificar se o arquivo existe
        if [ ! -f "$FILENAME" ]; then
          echo "‚ùå Tentando m√©todo direto do Google Drive..."
          
          # Tentar detectar Google Drive
          if echo "$URL" | grep -qi "drive.google.com"; then
            # Instalar gdown temporariamente
            pip3 install --quiet gdown
            
            # Extrair ID
            FILE_ID=$(echo "$URL" | sed -n \
              -e 's|.*/d/\([a-zA-Z0-9_-]*\).*|\1|p' \
              -e 's|.*id=\([a-zA-Z0-9_-]*\).*|\1|p')
            
            if [ -n "$FILE_ID" ]; then
              echo "üåê Baixando do Google Drive com ID: $FILE_ID"
              gdown "https://drive.google.com/uc?id=$FILE_ID" -O "$FILENAME"
            fi
          fi
        fi
        
        # Verifica√ß√£o final
        if [ ! -f "$FILENAME" ]; then
          echo "‚ùå‚ùå‚ùå ERRO: Nenhum arquivo foi baixado!"
          echo "üìÅ Conte√∫do da pasta:"
          ls -la
          exit 1
        fi
        
        echo "‚úÖ‚úÖ‚úÖ Download conclu√≠do!"
        echo "üìä Tamanho: $(ls -lh "$FILENAME")"
        
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT

    - name: Create Release (Fixed softprops method)
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "dl-$(date +%s)"
        name: "${{ steps.download_file.outputs.filename }}"
        body: |
          ## üì• Download Autom√°tico
          
          **Arquivo:** `${{ steps.download_file.outputs.filename }}`
          
          **URL Original:** ${{ inputs.download_url }}
          
          **Data:** $(date '+%d/%m/%Y %H:%M:%S')
          
          ---
          
          Baixado automaticamente via GitHub Actions.
        files: ${{ steps.download_file.outputs.filename }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify release creation
      run: |
        echo "‚úÖ Release criada com sucesso!"
        echo "üì¶ Arquivo: ${{ steps.download_file.outputs.filename }}"
        echo "üè∑Ô∏è  Tag: dl-$(date +%s)"
