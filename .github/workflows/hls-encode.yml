name: HLS Download and Encode

on:
  workflow_dispatch:
    inputs:
      hls_url:
        description: 'URL do stream HLS'
        required: true
        type: string
      output_format:
        description: 'Formato de sa√≠da (mp4, mkv, avi, mov)'
        required: false
        default: 'mp4'
        type: choice
        options:
          - mp4
          - mkv
          - avi
          - mov
      output_filename:
        description: 'Nome do arquivo de sa√≠da (sem extens√£o)'
        required: false
        default: 'output'
        type: string

jobs:
  download-and-encode:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v2
      with:
        ffmpeg-version: 6.1

    - name: Create output directory
      run: mkdir -p output

    - name: Download and encode HLS stream
      run: |
        # Validar URL
        if [[ -z "${{ github.event.inputs.hls_url }}" ]]; then
          echo "‚ùå URL do HLS n√£o fornecida"
          exit 1
        fi

        # Definir nome do arquivo de sa√≠da
        OUTPUT_FILE="output/${{ github.event.inputs.output_filename }}.${{ github.event.inputs.output_format }}"
        
        echo "üì• Baixando e convertendo stream HLS..."
        echo "üîó URL: ${{ github.event.inputs.hls_url }}"
        echo "üíæ Sa√≠da: $OUTPUT_FILE"
        
        # Baixar e converter o stream HLS
        ffmpeg -i "${{ github.event.inputs.hls_url }}" \
               -c copy \
               -bsf:a aac_adtstoasc \
               "$OUTPUT_FILE" \
               -y || exit 1
        
        # Verificar se o arquivo foi criado
        if [ ! -f "$OUTPUT_FILE" ]; then
          echo "‚ùå Falha ao criar o arquivo de sa√≠da"
          exit 1
        fi
        
        echo "‚úÖ Convers√£o conclu√≠da com sucesso!"
        echo "üìä Tamanho do arquivo: $(du -h "$OUTPUT_FILE" | cut -f1)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: converted-video
        path: output/
        retention-days: 7

    - name: Show download instructions
      run: |
        echo "üéâ Processamento conclu√≠do!"
        echo ""
        echo "üì• Para baixar o arquivo:"
        echo "1. V√° para a aba 'Actions'"
        echo "2. Clique nesta execu√ß√£o do workflow"
        echo "3. Des√ßa at√© 'Artifacts' e clique em 'converted-video'"
        echo "4. Baixe o arquivo ZIP e extraia o v√≠deo convertido"
        echo ""
        echo "üìÅ Arquivo gerado: ${{ github.event.inputs.output_filename }}.${{ github.event.inputs.output_format }}"
